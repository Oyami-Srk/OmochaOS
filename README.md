# OmochaOS
![Image](resource/OmochaLogo.bmp)

[中文Readme] | [[English Readme]](README_en.md)

--------------------------------------------------------

OmochaOS 是我的个人操作系统学习用项目。其中某些代码和底层设计参考了于渊的《Orange's 一个操作系统的实现》和 OSDev Wiki 。
部分代码由此项目的旧版本（该项目重写了多次，已经数不清了）直接继承而来，
关于我为什么对于操作系统内核开发如此感兴趣也在那个版本的 ReadMe 里。（[版本链接](https://github.com/Oyami-Srk/OmochaOS/tree/original_omochaos)）

这个版本的 OmochaOS 将尽可能地进行文档的编写。

## 目录
---------------
  * [内核构建](#内核构建)
    * [所需依赖](#所需依赖)
  * [创建磁盘镜像](#创建磁盘镜像)
  * [运行磁盘镜像](#运行磁盘镜像)
  * [调试内核](#调试内核)
  * [内核设计概要](#内核设计概要)
  * [规划](#规划)
  * [详细内容目录](#详细目录)
  * [鸣谢](#鸣谢)



## 内核构建
----------
本项目使用 CMake 作为构建系统，使用前请确保 CMake 的版本大于 3.0.0。目标 `kernel.elf` 则是符合 `multiboot` 规范，可以通过 `GRUB` 引导；或使用 `qemu` 的 `-kernel` 参数加载的内核二进制文件。

### 所需依赖
本项目需要使用能够编译为 `elf-32` 格式的 GCC 编译器，通常在 Linux 上安装 GCC 工具链即可，在 macOS 上可以安装 `x86_64-elf-gcc` 工具链进行交叉编译。本项目未在 Windows 操作系统上测试编译过，在理论上可以使用响应的交叉编译工具链进行编译。

同时，在处理代码、生成文件上，本项目需要一些常见的 GNU Binutils，比如`awk`、`sed`、`grep`、`cat`及安装有`pyyaml`的 Python3 解释器（用于生成内置模块的头文件）。


## 创建磁盘镜像
-------------
CMake 目标 `boot.img` 为可启动的 Raw 磁盘镜像。该目标调用`tools/build_image.sh`脚本来从带有 GRUB2 引导的空白镜像`tools/HD_grub2.img`生成带有`kernel.elf`和相应的 GRUB 配置文件的磁盘镜像。该脚本仅在 macOS（使用自带的`hdiutil`和`diskutil`）和 Linux （使用`udisksctl`来控制 loop 设备）上可用。若无法构建镜像，请检查相应的工具是否可以使用，或者在你的系统上实现该过程。

该脚本依赖`rsync`和`cp`来对`tools/root_dir`及配置文件`tools/grub.cfg`进行同步和拷贝。

## 运行磁盘镜像
-------------
CMake 目标 `RunQEMU` 和 `Bochs` 可以通过`qemu-system-i386`或`bochs` 来运行生成的磁盘镜像。

## 调试内核
-------------
使用`bochs`调试内核可以使用自带的调试器，不过这不是推荐的方法。一般采用`qemu`提供的 GDB 服务器来调试内核。CMake 目标 `DebugQEMU` 可以通过`qemu-system-i386`以调试模式启动镜像。并可通过 GDB 远程链接到 `localhost:4444` 进行调试。

## 内核设计概要
-------------
受到 Orangs 的影响，而 Orangs 又受到 Minix 的影响，本 OmochaOS 为微内核设计，但是为了开发的便捷及对性能的妥协，*内存管理模块*和一些系统级任务（如*systask*）在内核空间运行（意味着这些模块不可卸载且可以链接到内核态的符号）。当前大部分的模块都在内核空间运行，这仅仅是因为在系统初始化初期，为了方便代码的编写而将其静态链接到内核的二进制内（类似初始化内存盘），在系统初始化完毕可以读写硬盘时，这些内置的模块将被硬盘上对应的系统模块替代。

所有模块都运行在 Ring 1，且整个系统只有两个正式的系统调用，分别是`__recv_msg`及`__send_msg`（`__get_tick`为测试用的系统调用），这两个系统调用负责在不同的模块中传递信息，以达到IPC的效果，消息传递算法使用 Minix 的原地等待算法。

`interrupt_handler`在系统初始化完毕后在 Ring 0 下运行，负责处理所有的中断。
`systask`提供了一个进程访问内核信息和特权指令（例如将模块提权到 Ring 0）的途径，但是目前还没有实现。

## 规划
-------------
* VFS - 虚拟文件系统
* FATFS - FAT文件系统
* 移植 Newlib
* 编制简易终端
* ACPI驱动
* 对称多处理器支持
* 高级调度器算法
* 图形界面

## 详细目录
-------------
* 待完善

## 鸣谢
-------------
[![CLion](./resource/icon_CLion.png)](https://www.jetbrains.com/?from=OmochaOS)

本工程在本人学生授权的 CLion 上完成开发，感谢 CLion 提供的完备的调试器、代码补全等功能。